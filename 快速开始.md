# 快速开始指南

## 数据库信息

PostgreSQL数据库配置示例：
- **主机**: your_db_host
- **端口**: 5432
- **用户名**: your_db_user
- **密码**: your_db_password
- **数据库名**: postgres

## 快速配置步骤

### 1. 安装依赖

```bash
pip install -r requirements.txt
```

### 2. 配置环境变量

复制配置文件并修改：

```bash
cp env.example .env
```

编辑 `.env` 文件，确保以下配置正确：

```bash
# 临时数据库配置
TMP_DB_HOST=your_db_host
TMP_DB_PORT=5432
TMP_DB_NAME=postgres
TMP_DB_USER=your_db_user
TMP_DB_PASSWORD=your_db_password

# 租户ID（必须修改为实际值）
TENANT_ID=your_tenant_id
```

### 3. 创建临时表

执行SQL脚本创建临时表：

```bash
# 方式1：使用psql命令行
psql -h your_db_host -p 5432 -U your_db_user -d postgres -f init_tables.sql

# 方式2：如果提示输入密码，输入配置的数据库密码
```

或者使用Python测试脚本（会自动检查表是否存在）：

```bash
python test_db_connection.py
```

### 4. 测试数据库连接

```bash
python test_db_connection.py
```

如果连接成功，会显示：
```
✓ 数据库连接成功！
✓ tmp_user - 存在 (记录数: 0)
✓ tmp_organization - 存在 (记录数: 0)
✓ tmp_org_user_relation - 存在 (记录数: 0)
```

### 5. 运行同步脚本

```bash
python sync_org_from_idc.py
```

脚本会：
1. 从身份中台获取所有用户和组织架构信息
2. 写入到临时数据库的三张表中
3. 生成日志文件 `sync_org.log`

### 6. 查看同步结果

```bash
# 查看日志
tail -f sync_org.log

# 或者连接数据库查看数据
psql -h 10.10.161.44 -p 5432 -U pguser -d postgres

# 查看用户数量
SELECT COUNT(*) FROM tmp_user;

# 查看组织数量
SELECT COUNT(*) FROM tmp_organization;

# 查看用户-组织关系数量
SELECT COUNT(*) FROM tmp_org_user_relation;
```

## 重要提醒

1. **租户ID**: 必须从HiAgent环境获取实际的租户ID，替换 `.env` 文件中的 `your_tenant_id`
2. **首次运行**: 建议先使用测试模式，配置 `SAMPLE_USER_ID` 测试单个用户
3. **数据验证**: 同步完成后，可以通过数据库查询验证数据是否正确

## 常见问题

### Q: 数据库连接失败？
A: 检查：
- 网络是否能访问数据库服务器
- 用户名和密码是否正确
- 数据库名称是否正确（默认是 postgres）

### Q: 表不存在？
A: 执行 `init_tables.sql` 脚本创建表

### Q: 同步失败？
A: 查看 `sync_org.log` 日志文件，检查错误信息

## 下一步

同步完成后，数据已写入临时表，iam-adapter 会定时从临时表读取数据并同步到 HiAgent。

参考文档：
- [数据库配置说明.md](./数据库配置说明.md)
- [组织架构同步对接指南.md](./组织架构同步对接指南.md)

