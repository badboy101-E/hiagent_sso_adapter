# 数据库配置说明

## 数据库信息

已申请的PostgreSQL数据库信息：
- **主机**: 10.10.161.44
- **端口**: 5432
- **用户名**: pguser
- **密码**: s^-owmDP18
- **数据库名**: postgres（默认，如需使用其他数据库名请修改配置）

## 配置步骤

### 1. 创建配置文件

复制 `env.example` 为 `.env` 文件：

```bash
cp env.example .env
```

### 2. 修改 .env 文件

编辑 `.env` 文件，更新以下数据库配置：

```bash
# 临时数据库配置（PG数据库）
TMP_DB_HOST=10.10.161.44
TMP_DB_PORT=5432
TMP_DB_NAME=postgres
TMP_DB_USER=pguser
TMP_DB_PASSWORD=s^-owmDP18

# 租户ID（从HiAgent环境获取，需要替换为实际值）
TENANT_ID=your_tenant_id
```

### 3. 创建临时表

执行SQL脚本创建临时表：

```bash
# 方式1：使用psql命令行
psql -h 10.10.161.44 -p 5432 -U pguser -d postgres -f init_tables.sql

# 方式2：使用psql交互式
psql -h 10.10.161.44 -p 5432 -U pguser -d postgres
# 然后执行：
\i init_tables.sql
```

或者直接在数据库中执行 `init_tables.sql` 文件中的SQL语句。

### 4. 验证表创建

连接数据库验证表是否创建成功：

```bash
psql -h 10.10.161.44 -p 5432 -U pguser -d postgres

# 查看表
\dt tmp_*

# 查看表结构
\d tmp_user
\d tmp_organization
\d tmp_org_user_relation
```

## 临时表说明

根据"组织架构同步对接指南.md"，需要创建以下三张表：

1. **tmp_user** - 临时用户表
2. **tmp_organization** - 临时组织表
3. **tmp_org_user_relation** - 临时用户组织关系表

详细表结构请参考 `init_tables.sql` 文件。

## 运行同步脚本

配置完成后，运行同步脚本：

```bash
python sync_org_from_idc.py
```

脚本会自动：
1. 从身份中台获取用户和组织架构信息
2. 写入到临时数据库的三张表中
3. 生成日志文件 `sync_org.log`

## 注意事项

1. **租户ID**: 必须从HiAgent环境获取实际的租户ID，替换 `.env` 文件中的 `your_tenant_id`
2. **数据库权限**: 确保 `pguser` 用户有创建表和插入数据的权限
3. **网络连接**: 确保能访问数据库服务器 `10.10.161.44:5432`
4. **密码特殊字符**: 密码中包含特殊字符 `^`，在配置文件中需要正确转义（通常不需要转义）

## 测试连接

可以使用以下Python脚本测试数据库连接：

```python
import psycopg2

try:
    conn = psycopg2.connect(
        host="10.10.161.44",
        port=5432,
        database="postgres",
        user="pguser",
        password="s^-owmDP18"
    )
    print("数据库连接成功！")
    conn.close()
except Exception as e:
    print(f"数据库连接失败: {e}")
```

